{% extends 'tickets/base.html' %}

{% block title %}Ticket #{{ ticket.id }} - {{ ticket.title }}{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Ticket #{{ ticket.id }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'tickets:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'tickets:ticket_list' %}">Tickets</a></li>
                        <li class="breadcrumb-item active">Ticket #{{ ticket.id }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <!-- Ticket Details Column -->
                <div class="col-md-8">
                    <!-- Ticket Information Card -->
                    <div class="card card-outline card-danger">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-ticket-alt"></i>
                                {{ ticket.title }}
                            </h3>
                            <div class="card-tools">
                                {% if can_edit_ticket %}
                                    <button type="button" class="btn btn-tool" data-toggle="modal"
                                            data-target="#editTicketModal">
                                        {% if user.is_staff %}
                                            <i class="fas fa-cogs"></i> Admin Control
                                        {% else %}
                                            <i class="fas fa-edit"></i> Edit
                                        {% endif %}
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Priority & Status Badges -->
                            <div class="mb-3">
                                {% if ticket.priority == 'Urgent' %}
                                    <span class="badge badge-danger badge-lg">
                                    {{ ticket.priority }} Priority
                                </span>
                                {% elif ticket.priority == 'High' %}
                                    <span class="badge badge-warning badge-lg">
                                     {{ ticket.priority }} Priority
                                </span>
                                {% elif ticket.priority == 'Medium' %}
                                    <span class="badge badge-info badge-lg">
                                     {{ ticket.priority }} Priority
                                </span>
                                {% else %}
                                    <span class="badge badge-secondary badge-lg">
                                    {{ ticket.priority }} Priority
                                </span>
                                {% endif %}

                                {% if ticket.status == 'Open' %}
                                    <span class="badge badge-success badge-lg ml-2">
                                    <i class="fas fa-folder-open"></i> {{ ticket.status }}
                                </span>
                                {% elif ticket.status == 'In Progress' %}
                                    <span class="badge badge-warning badge-lg ml-2">
                                    <i class="fas fa-clock"></i> {{ ticket.status }}
                                </span>
                                {% else %}
                                    <span class="badge badge-secondary badge-lg ml-2">
                                    <i class="fas fa-check-circle"></i> {{ ticket.status }}
                                </span>
                                {% endif %}
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon bg-primary"><i class="fas fa-user"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Created By</span>
                                            <span class="info-box-number">
                                                {{ ticket.created_by.get_full_name|default:ticket.created_by.username|default:"Unassigned" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon bg-info"><i class="fas fa-user-check"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Assigned To</span>
                                            <span class="info-box-number">
                                                {% if ticket.assigned_to %}
                                                    {{ ticket.assigned_to.get_full_name|default:ticket.assigned_to.username }}
                                                {% else %}
                                                    <span class="text-muted">Unassigned</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CC Information -->
                            {% if ticket.cc_admins.exists or ticket.cc_non_admins.exists %}
                                <div class="row mb-4">
                                    {% if ticket.cc_admins.exists %}
                                        <div class="col-md-6">
                                            <div class="info-box bg-light">
                                                <span class="info-box-icon bg-warning"><i
                                                        class="fas fa-users"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">CC Admins</span>
                                                    <span class="info-box-number">
                                                {% for admin in ticket.cc_admins.all %}
                                                    <span class="badge badge-warning mr-1">{{ admin.get_full_name|default:admin.username }}</span>
                                                {% endfor %}
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if ticket.cc_non_admins.exists %}
                                        <div class="col-md-6">
                                            <div class="info-box bg-light">
                                                <span class="info-box-icon bg-secondary"><i
                                                        class="fas fa-users"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">CC Non-Admins</span>
                                                    <span class="info-box-number">
                                                {% for user in ticket.cc_non_admins.all %}
                                                    <span class="badge badge-secondary mr-1">{{ user.get_full_name|default:user.username }}</span>
                                                {% endfor %}
                                            </span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <!-- Description -->
                            <div class="mb-4">
                                <h5><i class="fas fa-file-alt"></i> Description</h5>
                                <div class="bg-light p-3 rounded">
                                    {{ ticket.description|linebreaks|default:"<em class='text-muted'>No description provided.</em>" }}
                                </div>
                            </div>

                            <!-- Timestamps -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon bg-primary"><i
                                                class="fas fa-calendar-plus"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Created</span>
                                            <span class="info-box-number">{{ ticket.created_at|date:"M d, Y" }}</span>
                                            <div class="progress">
                                                <div class="progress-bar bg-primary" style="width: 100%"></div>
                                            </div>
                                            <span class="progress-description">
                                            {{ ticket.created_at|time:"H:i" }}
                                        </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon bg-warning"><i
                                                class="fas fa-calendar-check"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Last Updated</span>
                                            <span class="info-box-number">{{ ticket.updated_at|date:"M d, Y" }}</span>
                                            <div class="progress">
                                                <div class="progress-bar bg-warning" style="width: 100%"></div>
                                            </div>
                                            <span class="progress-description">
                                            {{ ticket.updated_at|time:"H:i" }}
                                        </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="card card-outline card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-comments"></i> Comments & Updates
                            </h3>
                            <div class="card-tools">
                                <span class="badge badge-info">
                                    {{ timeline_entries|length }} update{{ timeline_entries|length|pluralize }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if ticket.status|lower == 'closed' %}
                                <!-- Reopen Ticket Section (when ticket is closed) -->
                                <div class="mb-4 p-4 bg-alert-warning rounded" role="alert">
                                    <i class="fas fa-info-circle"></i>
                                    This ticket is closed. To add comments or updates, please reopen the ticket first.
                                </div>
                                <button type="button" class="btn btn-warning btn-lg" data-toggle="modal" data-target="#reopenTicketModal">
                                    <i class="fas fa-folder-open"></i> Reopen Ticket
                                </button>
                            {% else %}
                                <!-- Add Comment Form (when ticket is open) -->
                                <form method="post" class="mb-4">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="add_comment">

                                    <div class="form-group">
                                        <label for="comment_content">Add a comment:</label>
                                        <textarea class="form-control" id="comment_content" name="comment_content"
                                                  rows="3"
                                                  placeholder="Share an update, ask a question, or provide additional information..."
                                                  required></textarea>
                                    </div>

                                    {% if can_add_internal_comments %}
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="is_internal"
                                                   name="is_internal">
                                            <label class="form-check-label" for="is_internal">
                                                <i class="fas fa-lock text-warning"></i> Internal comment (visible only to
                                                staff)
                                            </label>
                                        </div>
                                    {% endif %}

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Add Comment
                                    </button>
                                </form>
                            {% endif %}

                            <!-- Timeline List -->
                            {% if timeline_entries %}
                                <div class="timeline timeline-inverse">
                                    {% regroup timeline_entries by content.created_at|date:"Y-m-d" as grouped_entries %}
                                    {% for group in grouped_entries %}
                                        <!-- Date Label -->
                                        <div class="time-label">
                                            <span class="bg-primary">
                                                {{ group.grouper|date:"M d, Y" }}
                                            </span>
                                        </div>

                                        {% for entry in group.list %}
                                            {% if entry.type == 'comment' %}
                                                <!-- Comment Entry -->
                                                <div>
                                                    {% if entry.content.is_internal %}
                                                        <i class="fas fa-lock bg-warning"></i>
                                                    {% else %}
                                                        <i class="fas fa-comment bg-blue"></i>
                                                    {% endif %}

                                                    <div class="timeline-item">
                                                        <span class="time">
                                                            <i class="fas fa-clock"></i> {{ entry.content.created_at|date:"Y-m-d" }} <span class="ml-1 text-info">{{ entry.content.created_at|time:"H:i" }}</span>
                                                        </span>

                                                        <h3 class="timeline-header">
                                                            <a href="#" class="text-decoration-none">
                                                                {{ entry.content.author.get_full_name|default:entry.content.author.username }}</a>
                                                            {% if entry.content.is_internal %}
                                                                <span class="badge badge-warning">
                                                                    <i class="fas fa-lock"></i> Internal
                                                                </span>
                                                            {% endif %}
                                                            {% if entry.content.author.is_staff %}
                                                                <span class="badge badge-info">
                                                                    <i class="fas fa-user-shield"></i> Staff
                                                                </span>
                                                            {% endif %}
                                                            <!-- Edit/Delete Controls -->
                                                            {% if entry.content.author == user or user.is_staff %}
                                                                <div class="comment-actions float-right">
                                                                    <button type="button" class="comment-action-btn edit-comment-btn bg-warning"
                                                                            data-comment-id="{{ entry.content.id }}" 
                                                                            data-comment-content="{{ entry.content.content }}"
                                                                            data-comment-internal="{{ entry.content.is_internal }}"
                                                                            title="Edit comment">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    {% if user.is_staff %}
                                                                        <button type="button" class="comment-action-btn delete-comment-btn bg-danger"
                                                                                data-comment-id="{{ entry.content.id }}"
                                                                                data-comment-author="{{ entry.content.author.get_full_name|default:entry.content.author.username }}"
                                                                                title="Delete comment">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        </h3>

                                                        <div class="timeline-body">
                                                            <div id="comment-content-{{ entry.content.id }}">
                                                                {{ entry.content.content|linebreaks }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                            {% elif entry.type == 'update' %}
                                                <!-- Update Entry - Clean AdminLTE style -->
                                                <div>
                                                    <i class="{{ entry.content.icon_class }}"></i>
                                                    <div class="timeline-item">
                                                        <span class="time">
                                                            <i class="far fa-clock"></i> {{ entry.content.created_at|date:"Y-m-d" }} <span class="ml-1 text-info">{{ entry.content.created_at|time:"H:i" }}</span>
                                                        </span>

                                                        <h3 class="timeline-header no-border">
                                                            <span class="text-muted text-sm">
                                                                {{ entry.content.user_display_name }}
                                                                {{ entry.content.description }}
                                                            </span>
                                                        </h3>
                                                    </div>
                                                </div>

                                            {% elif entry.type == 'creation' %}
                                                <!-- Ticket Creation Entry -->
                                                <div>
                                                    <i class="fas fa-plus bg-green"></i>
                                                    <div class="timeline-item">
                                                    <span class="time">
                                                        <i class="fas fa-clock"></i> {{ ticket.created_at|time:"H:i" }}
                                                    </span>
                                                        <h3 class="timeline-header">
                                                            <a href="#" class="text-decoration-none">
                                                                {{ ticket.created_by.get_full_name|default:ticket.created_by.username }}</a>
                                                            created this ticket
                                                        </h3>
                                                        <div class="timeline-body">
                                                            <strong>{{ ticket.title }}</strong><br>
                                                            {{ ticket.description|linebreaks|truncatewords:20 }}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}

                                </div>
                            {% else %}
                                <div class="text-center p-4">
                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No activity yet</h5>
                                    <p class="text-muted">Be the first to add a comment or update!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sidebar Column -->
                <div class="col-md-4">
                    <!-- Quick Actions -->
                    <div class="card card-outline card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bolt"></i> Quick Actions
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="btn-group-vertical btn-block">
                                {% if can_edit_ticket %}
                                    <button type="button" class="btn btn-warning" data-toggle="modal"
                                            data-target="#editTicketModal">
                                        {% if user.is_staff %}
                                            <i class="fas fa-cogs"></i> Admin Control
                                        {% else %}
                                            <i class="fas fa-edit"></i> Edit Ticket
                                        {% endif %}
                                    </button>
                                {% endif %}

                                <a href="{% url 'tickets:ticket_list' %}" class="btn btn-info">
                                    <i class="fas fa-list"></i> Back to Tickets
                                </a>

                                <a href="{% url 'tickets:create_ticket' %}" class="btn btn-success">
                                    <i class="fas fa-plus-circle"></i> Create New Ticket
                                </a>

                                {% if user.is_staff %}
                                    <a href="/admin/tickets/ticket/{{ ticket.id }}/change/" target="_blank"
                                       class="btn btn-secondary">
                                        <i class="fas fa-cogs"></i> Admin Edit
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Computer Information Section -->
                    {% if ticket.computer_info and user.is_staff %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card card-outline card-info">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            <i class="fas fa-desktop"></i> Computer Information
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong></i> Hostname:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.hostname|default:"Not available" }}</p>

                                                <strong>Current User:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.current_user|default:"Not available" }}</p>

                                                <strong>Location:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.derby_plant_loc|default:"Not available" }}</p>

                                                <strong>IP Address:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.client_ip|default:"Not available" }}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Make/Model:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.pc_make_model|default:"Not available" }}</p>

                                                <strong>RAM:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.ram|default:"Not available" }}</p>

                                                <strong>Processor:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.processor_name|default:"Not available" }}</p>

                                                <strong>Operating System:</strong>
                                                <p class="text-muted">
                                                    {{ ticket.computer_info.os_name|default:"Not available" }}</p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <hr>
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i>
                                                    Computer information captured at ticket creation:
                                                    {{ ticket.computer_info.captured_at|date:"M d, Y H:i" }}
                                                    {% if ticket.computer_info.serial_number %}
                                                        | Serial: {{ ticket.computer_info.serial_number }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Move image here -->
                    <!-- Attachments Section -->
                    {% if ticket.attachments.all %}
                        <div class="mb-4">
                            <h5><i class="fas fa-paperclip"></i> Attachments ({{ ticket.attachments.count }})</h5>
                            <div id="attachmentsCarousel" class="carousel slide" data-ride="carousel">
                                <div class="carousel-inner">
                                    {% for attachment in ticket.attachments.all %}
                                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                            <div class="card h-100">
                                                {% if attachment.is_image %}
                                                    <!-- Image Attachment -->
                                                    <div class="card-img-top position-relative"
                                                         style="height: 200px; overflow: hidden;">
                                                        <img src="{{ attachment.get_secure_url }}"
                                                             alt="{{ attachment.original_filename }}"
                                                             class="img-fluid w-100 h-100"
                                                             style="object-fit: cover; cursor: pointer;"
                                                             onclick="openImageModal('{{ attachment.get_secure_url }}', '{{ attachment.original_filename }}')"
                                                             title="Click to view full size">
                                                        <div class="position-absolute" style="top: 5px; right: 5px;">
                                                        <span class="badge badge-success">
                                                            <i class="fas fa-image"></i>
                                                        </span>
                                                        </div>
                                                    </div>
                                                {% elif attachment.is_pdf %}
                                                    <!-- PDF Attachment -->
                                                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light"
                                                         style="height: 200px;">
                                                        <div class="text-center">
                                                            <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                                            <br>
                                                            <span class="badge badge-danger">PDF</span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                                <div class="card-body p-2">
                                                    <h6 class="card-title text-truncate"
                                                        title="{{ attachment.original_filename }}">
                                                        {{ attachment.original_filename }}
                                                    </h6>
                                                    <p class="card-text small text-muted mb-1">
                                                        <i class="fas fa-weight-hanging"></i> {{ attachment.file_size_mb }}
                                                        MB
                                                        <br>
                                                        <i class="fas fa-clock"></i>
                                                        {{ attachment.uploaded_at|date:"M d, Y H:i" }}
                                                        <br>
                                                        <i class="fas fa-user"></i>
                                                        {{ attachment.uploaded_by.get_full_name|default:attachment.uploaded_by.username }}
                                                    </p>
                                                    {% if attachment.description %}
                                                        <p class="card-text small">
                                                            <em>"{{ attachment.description }}"</em>
                                                        </p>
                                                    {% endif %}
                                                </div>
                                                <div class="card-footer p-2">
                                                    {% if attachment.is_image %}
                                                        <button class="btn btn-primary btn-sm btn-block"
                                                                onclick="openImageModal('{{ attachment.get_secure_url }}', '{{ attachment.original_filename }}')">
                                                            <i class="fas fa-eye"></i> View Image
                                                        </button>
                                                    {% elif attachment.is_pdf %}
                                                        <a href="{{ attachment.get_secure_url }}"
                                                           target="_blank"
                                                           class="btn btn-danger btn-sm btn-block">
                                                            <i class="fas fa-external-link-alt"></i> Open PDF
                                                        </a>
                                                    {% endif %}
                                                    <a href="{{ attachment.get_secure_url }}"
                                                       download="{{ attachment.original_filename }}"
                                                       class="btn btn-success btn-sm btn-block mt-1">
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <a class="carousel-control-prev" href="#attachmentsCarousel" role="button"
                                   data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="carousel-control-next" href="#attachmentsCarousel" role="button"
                                   data-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Related Tickets -->
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-link"></i> Related Tickets
                            </h3>
                            {% if related_tickets %}
                                <div class="card-tools">
                                    <span class="badge badge-primary">{{ related_tickets|length }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            {% if related_tickets %}
                                {% for related in related_tickets %}
                                    <div class="d-flex justify-content-between align-items-start mb-3 p-2 border rounded">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <a href="{% url 'tickets:ticket_detail' related.ticket.pk %}"
                                                   class="text-primary">
                                                    #{{ related.ticket.id }}
                                                    - {{ related.ticket.title|truncatechars:40 }}
                                                </a>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> {{ related.reason }}
                                            </small>
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i>
                                                {{ related.ticket.created_at|date:"M d, Y" }}
                                                {% if related.ticket.status == 'Open' %}
                                                    <span class="badge badge-success badge-sm ml-1">{{ related.ticket.status }}</span>
                                                {% elif related.ticket.status == 'In Progress' %}
                                                    <span class="badge badge-warning badge-sm ml-1">{{ related.ticket.status }}</span>
                                                {% else %}
                                                    <span class="badge badge-secondary badge-sm ml-1">{{ related.ticket.status }}</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="text-right">
                                            {% if related.ticket.priority == 'Urgent' %}
                                                <span class="badge badge-danger badge-sm">{{ related.ticket.priority }}</span>
                                            {% elif related.ticket.priority == 'High' %}
                                                <span class="badge badge-warning badge-sm">{{ related.ticket.priority }}</span>
                                            {% elif related.ticket.priority == 'Medium' %}
                                                <span class="badge badge-info badge-sm">{{ related.ticket.priority }}</span>
                                            {% else %}
                                                <span class="badge badge-secondary badge-sm">{{ related.ticket.priority }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center p-3">
                                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No related tickets found.</p>
                                    <small class="text-muted">
                                        Related tickets are found based on category, keywords, and references.
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Ticket Modal -->
    {% if can_edit_ticket %}
        <div class="modal fade" id="editTicketModal" tabindex="-1" role="dialog" aria-labelledby="editTicketModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTicketModalLabel">
                            {% if user.is_staff %}
                                <i class="fas fa-cogs"></i> Admin Control - Ticket #{{ ticket.id }}
                            {% else %}
                                <i class="fas fa-edit"></i> Edit Ticket #{{ ticket.id }}
                            {% endif %}
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            {% if ticket.status|lower == 'closed' and user.is_staff %}
                                <!-- Warning banner for closed tickets (admin only) -->
                                <div class="mb-4 p-4 bg-alert-warning rounded" role="alert">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Warning:</strong> This ticket is closed. Editing will reopen it unless you choose "Keep it Closed".
                                </div>
                            {% endif %}
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" class="form-control" id="title" name="title"
                                       value="{{ ticket.title }}" required>
                            </div>

                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea class="form-control" id="description" name="description"
                                          rows="4">{{ ticket.description }}</textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="priority">Priority</label>
                                        <select class="form-control" id="priority" name="priority">
                                            <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}>
                                                Low
                                            </option>
                                            <option value="Medium"
                                                    {% if ticket.priority == 'Medium' %}selected{% endif %}>Medium
                                            </option>
                                            <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}>
                                                High
                                            </option>
                                            <option value="Urgent"
                                                    {% if ticket.priority == 'Urgent' %}selected{% endif %}>Urgent
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                {% if user.is_staff %}
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="status">Status</label>
                                            <select class="form-control" id="status" name="status">
                                                <option value="Open"
                                                        {% if ticket.status == 'Open' %}selected{% endif %}>Open
                                                </option>
                                                <option value="In Progress"
                                                        {% if ticket.status == 'In Progress' %}selected{% endif %}>In
                                                    Progress
                                                </option>
                                                <option value="Closed"
                                                        {% if ticket.status == 'Closed' %}selected{% endif %}>Closed
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            {% if user.is_staff %}
                                <!-- Admin-only fields -->
                                <hr>
                                <h6><i class="fas fa-user-shield"></i> Administrative Controls</h6>

                                <div class="form-group">
                                    <label for="assigned_to">Assign To</label>
                                    <select class="form-control" id="assigned_to" name="assigned_to">
                                        <option value="">-- Unassigned --</option>
                                        {% for staff_user in staff_users %}
                                            <option value="{{ staff_user.id }}"
                                                    {% if ticket.assigned_to and ticket.assigned_to.id == staff_user.id %}selected{% endif %}>
                                                {{ staff_user.get_full_name|default:staff_user.username }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cc_admins">
                                                <i class="fas fa-user-shield text-success"></i> CC Admins
                                            </label>
                                            <select class="form-control select2 cc-admins-select" id="cc_admins" name="cc_admins" multiple data-placeholder="Select admins to CC...">
                                                {% for admin_user in admin_users %}
                                                    <option value="{{ admin_user.id }}"
                                                            {% if admin_user in ticket.cc_admins.all %}selected{% endif %}>
                                                        {{ admin_user.get_full_name|default:admin_user.username }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> Staff members who will receive updates
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cc_non_admins">
                                                <i class="fas fa-users text-info"></i> CC Users
                                            </label>
                                            <select class="form-control select2 cc-users-select" id="cc_non_admins" name="cc_non_admins"
                                                    multiple data-placeholder="Select users to CC...">
                                                {% for regular_user in regular_users %}
                                                    <option value="{{ regular_user.id }}"
                                                            {% if regular_user in ticket.cc_non_admins.all %}selected{% endif %}>
                                                        {{ regular_user.get_full_name|default:regular_user.username }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i> Regular users who will receive updates
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Image Viewer Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">
                        <i class="fas fa-image"></i> <span id="imageModalTitle">Image Preview</span>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="imageModalImg" src="" alt="" class="img-fluid w-100" style="max-height: 70vh;">
                </div>
                <div class="modal-footer">
                    <a id="imageDownloadBtn" href="" download="" class="btn btn-success">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Comment Modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1" role="dialog" aria-labelledby="editCommentModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCommentModalLabel">
                        <i class="fas fa-edit"></i> Edit Comment
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit_comment">
                    <input type="hidden" name="comment_id" id="editCommentId">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="editCommentContent">Comment:</label>
                            <textarea class="form-control" id="editCommentContent" name="comment_content" 
                                      rows="4" required placeholder="Edit your comment..."></textarea>
                        </div>
                        {% if can_add_internal_comments %}
                            <div class="form-group">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editCommentInternal" 
                                           name="is_internal">
                                    <label class="form-check-label" for="editCommentInternal">
                                        <i class="fas fa-lock text-warning"></i> Internal comment (visible only to staff)
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Comment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Comment Modal -->
    <div class="modal fade" id="deleteCommentModal" tabindex="-1" role="dialog" aria-labelledby="deleteCommentModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCommentModalLabel">
                        <i class="fas fa-trash text-danger"></i> Delete Comment
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_comment">
                    <input type="hidden" name="comment_id" id="deleteCommentId">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> This action cannot be undone.
                        </div>
                        <p>Are you sure you want to delete the comment by <strong id="deleteCommentAuthor"></strong>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Comment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reopen Ticket Modal -->
    <div class="modal fade" id="reopenTicketModal" tabindex="-1" role="dialog" aria-labelledby="reopenTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="reopenTicketModalLabel">
                        <i class="fas fa-folder-open"></i> Reopen Ticket #{{ ticket.id }}
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="reopenTicketForm" method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reopen_ticket">
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Please provide a reason for reopening this ticket. This will be added as a comment and all relevant parties will be notified.
                        </div>
                        
                        <div class="form-group">
                            <label for="reopen_reason">Reason for reopening <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="reopen_reason" name="reopen_reason" 
                                      rows="4" 
                                      placeholder="Please explain why this ticket needs to be reopened..."
                                      required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-folder-open"></i> Reopen Ticket
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_css %}
    <style>
        /* AdminLTE Timeline Styling */
        .timeline {
            position: relative;
            margin: 0 0 30px 0;
            padding: 0;
            list-style: none;
        }

        .text-sm {
            font-size: .65rem !important;
            font-weight: 400;
            font-style: oblique;
        }

        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ddd;
            left: 31px;
            margin: 0;
            border-radius: 2px;
        }

        .timeline > li {
            position: relative;
            margin-right: 10px;
            margin-bottom: 15px;
        }

        .timeline > li:before,
        .timeline > li:after {
            content: " ";
            display: table;
        }

        .timeline > li:after {
            clear: both;
        }

        .timeline > li > .timeline-item {
            background: #fff;
            border-radius: 3px;
            margin-top: 0;
            color: #444;
            margin-left: 60px;
            margin-right: 15px;
            padding: 0;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        .timeline > li > .timeline-item:before {
            content: '';
            display: block;
            position: absolute;
            left: -15px;
            top: 20px;
            width: 0;
            height: 0;
            border: 7px solid transparent;
            border-right-color: #fff;
        }

        .timeline > li > .timeline-item > .time {
            color: #999;
            font-size: 11px;
            padding: 10px;
            margin: 0;
            background: #f9f9f9;
            border-bottom: 1px solid #f4f4f4;
        }

        .timeline > li > .timeline-item > .timeline-header {
            margin: 0;
            color: #555;
            border-bottom: 1px solid #f4f4f4;
            padding: 10px;
            font-size: 16px;
            line-height: 1.1;
        }

        .timeline > li > .timeline-item > .timeline-header.no-border {
            border-bottom: 0;
            padding: 10px;
        }

        .timeline > li > .timeline-item > .timeline-body,
        .timeline > li > .timeline-item > .timeline-footer {
            padding: 10px;
        }

        .timeline > li > .fa,
        .timeline > li > .fas,
        .timeline > li > .far,
        .timeline > li > .fab,
        .timeline > li > .fal,
        .timeline > li > .fad,
        .timeline > li > .ion {
            width: 30px;
            height: 30px;
            font-size: 15px;
            line-height: 30px;
            position: absolute;
            color: #666;
            background: #d2d6de;
            border-radius: 50%;
            text-align: center;
            left: 18px;
            top: 0;
        }

        .timeline > .time-label > span {
            font-weight: 600;
            color: #fff;
            font-size: 12px;
            padding: 5px;
            display: inline-block;
            background-color: #00a65a;
            border-radius: 4px;
        }

        /* Description blocks for ticket creation */
        .description-block {
            display: block;
            margin: 10px 0;
            text-align: center;
        }

        .description-block.border-right {
            border-right: 1px solid #f4f4f4;
        }

        .description-header {
            margin: 0;
            padding: 0;
            font-weight: 600;
            font-size: 16px;
        }

        .description-text {
            text-transform: uppercase;
            font-size: 12px;
            font-weight: 600;
        }

        .description-percentage {
            color: #00a65a;
            font-size: 20px;
            display: block;
        }

        /* Responsive timeline */
        @media (max-width: 767px) {
            .timeline > li > .timeline-item {
                margin-left: 45px;
                margin-right: 10px;
            }

            .timeline > li > .timeline-item:before {
                left: -10px;
                border-right-color: #fff;
            }

            .timeline > li > .fa,
            .timeline > li > .fas,
            .timeline > li > .far {
                left: 15px;
                width: 25px;
                height: 25px;
                font-size: 12px;
                line-height: 25px;
            }

            /* Stack timeline header content on mobile */
            .timeline-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .comment-actions {
                margin-left: 0;
                margin-top: 5px;
                align-self: flex-end;
            }

            .comment-action-btn {
                padding: 6px 8px;
                font-size: 14px;
            }
        }

        /* Text utilities */
        .text-decoration-none {
            text-decoration: none !important;
        }

        .text-green {
            color: #00a65a !important;
        }

        .text-blue {
            color: #3c8dbc !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script>
        $(document).ready(function () {
            // Initialize Select2 for CC fields with enhanced configuration
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%',
                allowClear: true,
                closeOnSelect: false,
                placeholder: function(){
                    return $(this).data('placeholder');
                },
                templateResult: formatUser,
                templateSelection: formatUserSelection,
                escapeMarkup: function(markup) {
                    return markup;
                }
            });

            // Custom formatting for user options in dropdown
            function formatUser(user) {
                if (!user.id) {
                    return user.text;
                }
                
                var $user = $(
                    '<span><i class="fas fa-user-circle mr-2"></i>' + user.text + '</span>'
                );
                return $user;
            }

            // Custom formatting for selected users
            function formatUserSelection(user) {
                if (!user.id) {
                    return user.text;
                }
                return user.text;
            }

            // Add visual feedback when users are selected/deselected
            $('.select2').on('select2:select', function (e) {
                var data = e.params.data;
                showNotification('Added: ' + data.text, 'success');
            });

            $('.select2').on('select2:unselect', function (e) {
                var data = e.params.data;
                showNotification('Removed: ' + data.text, 'info');
            });

            // Show notification function
            function showNotification(message, type) {
                var alertClass = 'alert-' + (type === 'success' ? 'success' : 'info');
                var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 250px;">' +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span>' +
                    '</button>' +
                    '<i class="fas fa-' + (type === 'success' ? 'check' : 'info') + '-circle mr-2"></i>' + message +
                    '</div>');
                
                $('body').append(notification);
                
                // Auto-dismiss after 3 seconds
                setTimeout(function() {
                    notification.alert('close');
                }, 3000);
            }

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip();

            // Handle form submission with loading state
            $('#editTicketModal form').submit(function () {
                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Saving...')
                    .prop('disabled', true);
            });

            // Auto-hide the edit modal if there are form errors
            // {% if form.errors %}
                //     $('#editTicketModal').modal('show');
                // {% endif %}

            // Handle comment editing
            $('.edit-comment-btn').click(function() {
                const commentId = $(this).data('comment-id');
                const commentContent = $(this).data('comment-content');
                const commentInternal = $(this).data('comment-internal');
                
                $('#editCommentId').val(commentId);
                $('#editCommentContent').val(commentContent);
                $('#editCommentInternal').prop('checked', commentInternal);
                $('#editCommentModal').modal('show');
            });

            // Handle comment deletion
            $('.delete-comment-btn').click(function() {
                const commentId = $(this).data('comment-id');
                const commentAuthor = $(this).data('comment-author');
                
                $('#deleteCommentId').val(commentId);
                $('#deleteCommentAuthor').text(commentAuthor);
                $('#deleteCommentModal').modal('show');
            });

            // Handle reopen ticket form submission
            $('#reopenTicketForm').submit(function(e) {
                const submitBtn = $(this).find('button[type="submit"]');
                const reasonField = $('#reopen_reason');
                
                // Validate reason is not empty
                if (!reasonField.val().trim()) {
                    alert('Please provide a reason for reopening this ticket.');
                    reasonField.focus();
                    e.preventDefault();
                    return false;
                }
                
                // Show loading state
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Reopening...')
                    .prop('disabled', true);
            });
        });

        // Function to open image modal
        function openImageModal(imageUrl, filename) {
            $('#imageModalImg').attr('src', imageUrl);
            $('#imageModalImg').attr('alt', filename);
            $('#imageModalTitle').text(filename);
            $('#imageDownloadBtn').attr('href', imageUrl);
            $('#imageDownloadBtn').attr('download', filename);
            $('#imageModal').modal('show');
        }
    </script>
{% endblock %}
