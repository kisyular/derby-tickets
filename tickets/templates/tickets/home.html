{% extends 'tickets/base.html' %} {% block title %}Dashboard - Ticket Management
System{% endblock %} {% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">Dashboard</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item active">Dashboard</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <!-- Info boxes (Stat boxes) -->
    <div class="row">
      <div class="col-lg-3 col-6">
        <!-- Total Tickets -->
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ total_tickets }}</h3>
            <p>Total Tickets</p>
          </div>
          <div class="icon">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <a href="{% url 'tickets:ticket_list' %}" class="small-box-footer">
            More info <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <!-- Open Tickets -->
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ open_tickets }}</h3>
            <p>Open Tickets</p>
          </div>
          <div class="icon">
            <i class="fas fa-folder-open"></i>
          </div>
          <a
            href="{% url 'tickets:ticket_list' %}?status=Open"
            class="small-box-footer"
          >
            More info <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <!-- In Progress Tickets -->
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ in_progress_tickets }}</h3>
            <p>In Progress</p>
          </div>
          <div class="icon">
            <i class="fas fa-clock"></i>
          </div>
          <a
            href="{% url 'tickets:ticket_list' %}?status=In%20Progress"
            class="small-box-footer"
          >
            More info <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <!-- Closed Tickets -->
        <div class="small-box bg-danger">
          <div class="inner">
            <h3>{{ closed_tickets }}</h3>
            <p>Closed Tickets</p>
          </div>
          <div class="icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <a
            href="{% url 'tickets:ticket_list' %}?status=Closed"
            class="small-box-footer"
          >
            More info <i class="fas fa-arrow-circle-right"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row">
      <div class="col-12">
        <div class="card card-outline card-danger">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-bolt"></i> Quick Actions
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <a
                  href="{% url 'tickets:create_ticket' %}"
                  class="btn btn-outline-success btn-lg btn-block mt-1"
                >
                  <i class="fas fa-plus-circle"></i> Create New Ticket
                </a>
              </div>
              <div class="col-md-4">
                <a
                  href="{% url 'tickets:ticket_list' %}"
                  class="btn btn-outline-primary btn-lg btn-block mt-1"
                >
                  <i class="fas fa-list"></i> View All Tickets
                </a>
              </div>
              <div class="col-md-4">
                {% if user.is_staff %}
                <a
                  href="/admin/"
                  target="_blank"
                  class="btn btn-outline-secondary btn-lg btn-block mt-1"
                >
                  <i class="fas fa-cogs"></i> Admin Panel
                </a>
                {% else %}
                <a
                  href="{% url 'tickets:ticket_list' %}?status=Open"
                  class="btn btn-info btn-lg btn-block mt-1"
                >
                  <i class="fas fa-folder-open"></i> My Open Tickets
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Overview Row -->
    {% if user.is_staff %}
    <div class="row">
      <div class="col-lg-3 col-6">
        <div class="info-box">
          <span class="info-box-icon bg-success">
            <i class="fas fa-chart-line"></i>
          </span>
          <div class="info-box-content">
            <span class="info-box-text">Resolution Rate</span>
            <span class="info-box-number"
              >{{ analytics_data.totals.resolution_rate }}%</span
            >
            <span class="progress-description">
              {{ closed_tickets }} of {{ total_tickets }} resolved
            </span>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="info-box">
          <span class="info-box-icon bg-info">
            <i class="fas fa-clock"></i>
          </span>
          <div class="info-box-content">
            <span class="info-box-text">Avg Response Time</span>
            <span class="info-box-number">
              {% if analytics_data.performance.avg_first_response_hours %} 
              {{  analytics_data.performance.avg_first_response_hours }}h {% else %}
              N/A {% endif %}
            </span>
            <span class="progress-description"> First response time </span>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="info-box">
          <span class="info-box-icon bg-warning">
            <i class="fas fa-plus"></i>
          </span>
          <div class="info-box-content">
            <span class="info-box-text">New This Week</span>
            <span class="info-box-number">{{ new_this_week }}</span>
            <span class="progress-description">
              Tickets created this week
            </span>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-6">
        <div class="info-box">
          <span class="info-box-icon bg-primary">
            <i class="fas fa-check"></i>
          </span>
          <div class="info-box-content">
            <span class="info-box-text">Closed This Week</span>
            <span class="info-box-number">{{ closed_this_week }}</span>
            <span class="progress-description">
              Weekly closure rate: {{ analytics_data.recent_activity.weekly_closure_rate }}%
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
      <div class="col-md-6">
        <div class="card card-outline card-secondary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-pie"></i> Priority Distribution
            </h3>
          </div>
          <div class="card-body">
            <canvas
              id="priorityChart"
              style="
                min-height: 250px;
                height: 250px;
                max-height: 250px;
                max-width: 100%;
              "
            ></canvas>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card card-outline card-secondary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-bar"></i> Status Overview
            </h3>
          </div>
          <div class="card-body">
            <canvas
              id="statusChart"
              style="
                min-height: 250px;
                height: 250px;
                max-height: 250px;
                max-width: 100%;
              "
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Most Active Users (Last 7 Days) -->
    <div class="row">
      <div class="col-md-6">
        <div class="card card-outline card-info">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-users"></i> Most Active Users (Last 7 Days)
            </h3>
          </div>
          <div class="card-body table-responsive p-0">
            {% if most_active_users %}
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Actions</th>
                  <th>Activity Level</th>
                </tr>
              </thead>
              <tbody>
                {% for user in most_active_users %}
                <tr>
                  <td>
                    <strong>{{ user.email }}</strong>
                  </td>
                  <td>
                    <span class="badge badge-primary"
                      >{{ user.activity_count }}</span
                    >
                  </td>
                  <td>
                    <div class="progress progress-xs">
                      {% with max_activity=most_active_users.0.activity_count %}
                      <div
                        class="progress-bar bg-success"
                        style="width: {% widthratio user.activity_count max_activity 100 %}%"
                      ></div>
                      {% endwith %}
                    </div>
                    <small class="text-muted"
                      >{{ user.activity_count }} actions</small
                    >
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <div class="p-4 text-center">
              <i class="fas fa-user-slash fa-2x text-muted mb-3"></i>
              <p class="text-muted">No user activity in the last 7 days</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Additional space for future widgets -->
      <div class="col-md-6">
        <div class="card card-outline card-warning">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-line"></i> Weekly Activity Summary
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <div class="description-block border-right">
                  <span class="description-percentage text-success">
                    <i class="fas fa-plus"></i>
                  </span>
                  <h5 class="description-header">{{ new_this_week }}</h5>
                  <span class="description-text">NEW TICKETS</span>
                </div>
              </div>
              <div class="col-6">
                <div class="description-block">
                  <span class="description-percentage text-info">
                    <i class="fas fa-check"></i>
                  </span>
                  <h5 class="description-header">{{ closed_this_week }}</h5>
                  <span class="description-text">RESOLVED</span>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <h6>Week Performance</h6>
              <div class="progress">
                <div
                  class="progress-bar bg-success"
                  style="width: {{ analytics_data.recent_activity.weekly_closure_rate }}%"
                >
                  {{ analytics_data.recent_activity.weekly_closure_rate }}%
                  Resolution Rate
                </div>
              </div>
              <small class="text-muted">
                {% if analytics_data.recent_activity.weekly_closure_rate >= 80 %}
                <i class="fas fa-thumbs-up text-success"></i> Excellent
                performance this week! {% elif analytics_data.recent_activity.weekly_closure_rate >= 60 %}
                <i class="fas fa-thumbs-up text-warning"></i> Good performance
                this week {% else %}
                <i class="fas fa-exclamation-triangle text-danger"></i> Room for
                improvement {% endif %}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Recent Tickets -->
    <div class="row">
      <div class="col-12">
        <div class="card card-outline card-secondary">
          <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-history"></i> Recent Tickets
            </h3>
            <div class="card-tools">
              <a href="{% url 'tickets:ticket_list' %}" class="btn btn-tool">
                <i class="fas fa-external-link-alt"></i> View All
              </a>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            {% if recent_tickets %}
            <table class="table table-hover text-nowrap">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in recent_tickets %}
                <tr class="{% if ticket.priority == 'Urgent' %}ticket-priority-urgent{% elif ticket.priority == 'High' %}ticket-priority-high{% elif ticket.priority == 'Medium' %}ticket-priority-medium{% else %}ticket-priority-low{% endif %}">
                  <td>{{ ticket.id }}</td>
                  <td>
                    <a href="{% url 'tickets:ticket_detail' ticket.pk %}">
                      {{ ticket.title }}
                    </a>
                  </td>
                  <td>
                    {% if ticket.priority == 'Urgent' %}
                    <span class="badge badge-danger">
                      {{ ticket.priority }}
                    </span>
                    {% elif ticket.priority == 'High' %}
                    <span class="badge badge-warning">
                      {{ ticket.priority }}
                    </span>
                    {% elif ticket.priority == 'Medium' %}
                    <span class="badge badge-info">
                      {{ ticket.priority }}
                    </span>
                    {% else %}
                    <span class="badge badge-secondary">
                      {{ ticket.priority }}
                    </span>
                    {% endif %}
                  </td>
                  <td>
                    {% if ticket.status == 'Open' %}
                    <span class="badge badge-success">{{ ticket.status }}</span>
                    {% elif ticket.status == 'In Progress' %}
                    <span class="badge badge-warning">{{ ticket.status }}</span>
                    {% else %}
                    <span class="badge badge-secondary"
                      >{{ ticket.status }}</span
                    >
                    {% endif %}
                  </td>
                  <td>
                      <small>{{ ticket.created_at }}</small>
                  </td>
                  <td>
                      <a
                      href="{% url 'tickets:ticket_detail' ticket.pk %}"
                      class="btn btn-sm btn-outline-primary"
                      data-toggle="tooltip"
                      title="View Details"
                    >
                      <i class="fas fa-eye"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <div class="p-4 text-center">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted">
                No tickets found.
                <a href="{% url 'tickets:create_ticket' %}"
                  >Create your first ticket</a
                >!
              </p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_css %}
<style>
  .info-box {
    display: block;
    min-height: 90px;
    background: #fff;
    width: 100%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    border-radius: 2px;
    margin-bottom: 15px;
  }

  .info-box-icon {
    border-radius: 2px 0 0 2px;
    display: block;
    float: left;
    height: 90px;
    width: 90px;
    text-align: center;
    font-size: 45px;
    line-height: 90px;
    background: rgba(0, 0, 0, 0.2);
  }

  .info-box-content {
    padding: 5px 10px;
    margin-left: 90px;
  }

  .info-box-number {
    display: block;
    font-weight: bold;
    font-size: 18px;
  }

  .info-box-text,
  .progress-description {
    display: block;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .progress-description {
    color: #999;
    font-size: 12px;
  }

  .description-block {
    display: block;
    margin: 10px 0;
    text-align: center;
  }

  .description-block.border-right {
    border-right: 1px solid #f4f4f4;
  }

  .description-header {
    margin: 0;
    padding: 0;
    font-weight: 600;
    font-size: 16px;
  }

  .description-text {
    text-transform: uppercase;
    font-size: 12px;
    font-weight: 600;
  }

  .description-percentage {
    color: #00a65a;
    font-size: 20px;
    display: block;
  }

  .progress-xs {
    height: 7px;
  }
</style>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  $(document).ready(function () {
      // Dashboard loaded
      console.log("Dashboard loaded successfully!");

      // Priority Distribution Chart
      const priorityCtx = document.getElementById('priorityChart').getContext('2d');
      const priorityChart = new Chart(priorityCtx, {
          type: 'bar',
          data: {
              labels: [
                  {% for stat in priority_stats %}'{{ stat.priority }}'{% if not forloop.last %}, {% endif %}{% endfor %}
              ],
              datasets: [{
                  data: [
                      {% for stat in priority_stats %}{{ stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}
                  ],
                  backgroundColor: [
                      '#212121',  // Almost black (Urgent)
                      '#424242',  // Dark gray (High)
                      '#757575',  // Medium gray (Medium)
                      '#bdbdbd'   // Light gray (Low)

                  ],
                  borderWidth: 1,
                  borderColor: '#fff'
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1
                      }
                  }
              },
              plugins: {
                  legend: {
                      display: false
                  }
              }
          }
      });

      // Status Overview Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      const statusChart = new Chart(statusCtx, {
          type: 'bar',
          data: {
              labels: ['Open', 'In Progress', 'Closed'],
              datasets: [{
                  label: 'Tickets',
                  data: [{{ open_tickets }}, {{ in_progress_tickets }}, {{ closed_tickets }}],
                  backgroundColor: [
                      '#424242',  // Green for Open
                      '#212121',  // Yellow for In Progress
                      '#6c757d'   // Gray for Closed
                  ],
                  borderColor: [
                      'white',
                      'white',
                      'white'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1
                      }
                  }
              },
              plugins: {
                  legend: {
                      display: false
                  }
              }
          }
      });
  });
</script>
{% endblock %}
