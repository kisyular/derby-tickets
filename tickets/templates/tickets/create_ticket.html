{% extends 'tickets/base.html' %}

{% block title %}Create New Ticket - Ticket Management System{% endblock %}

{% block extra_css %}
<style>
/* Custom Multiselect Styles - Dark/Light Mode Compatible */
.multiselect-container {
    position: relative;
}

.multiselect-input {
    cursor: text;
    min-height: 38px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    background-color: var(--bs-body-bg, #fff);
    color: var(--bs-body-color, #212529);
}

.multiselect-input:focus-within {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.search-input {
    background: transparent;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    flex-grow: 1;
    min-width: 150px;
    padding: 0;
    color: inherit;
}

.multiselect-dropdown {
    display: none;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--bs-border-color, #ced4da);
    color: var(--bs-dropdown-color, #212529);
}

.multiselect-option {
    cursor: pointer;
    padding: 0.5rem 1rem;
    border: none;
    transition: background-color 0.15s ease-in-out;
    background-color: transparent;
    color: inherit;
}

.multiselect-option:hover {
    background-color: var(--bs-dropdown-link-hover-bg, rgba(0, 0, 0, 0.04)) !important;
    color: var(--bs-dropdown-link-hover-color, #1e2125) !important;
}

.multiselect-option.active {
    background-color: var(--bs-primary, #007bff) !important;
}

.multiselect-option.active:hover {
    background-color: var(--bs-primary-dark, #0056b3) !important;
}

.badge {
    font-size: 0.875em;
    padding: 0.375rem 0.5rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
    background-color: var(--bs-primary, #007bff);
    color: #fff;
    border: 1px solid var(--bs-primary, #007bff);
}

.btn-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 1.2em;
    line-height: 1;
    opacity: 0.7;
    padding: 0 0.25rem;
    margin-left: 0.25rem;
    cursor: pointer;
    transition: opacity 0.15s ease-in-out;
    border-radius: 0.25rem;
}

.btn-close:hover {
    opacity: 1;
    background-color: rgba(255, 255, 255, 0.2);
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

/* Dark mode specific adjustments */
@media (prefers-color-scheme: dark) {
    .multiselect-input {
        background-color: var(--bs-dark, #343a40);
        border-color: var(--bs-border-color-translucent, rgba(255, 255, 255, 0.15));
        color: var(--bs-light, #f8f9fa);
    }
    
    .multiselect-dropdown {
        background-color: var(--bs-dark, #343a40);
        border-color: var(--bs-border-color-translucent, rgba(255, 255, 255, 0.15));
        color: var(--bs-light, #f8f9fa);
    }
    
    .multiselect-option:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: var(--bs-light, #f8f9fa) !important;
    }
}

/* AdminLTE dark mode compatibility */
[data-theme="dark"] .multiselect-input,
.dark-mode .multiselect-input {
    background-color: #343a40;
    border-color: rgba(255, 255, 255, 0.15);
    color: #f8f9fa;
}

[data-theme="dark"] .multiselect-dropdown,
.dark-mode .multiselect-dropdown {
    background-color: #343a40;
    border-color: rgba(255, 255, 255, 0.15);
    color: #f8f9fa;
}

[data-theme="dark"] .multiselect-option:hover,
.dark-mode .multiselect-option:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
    color: #f8f9fa !important;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .search-input {
        min-width: 100px;
    }
    
    .badge {
        font-size: 0.75em;
        padding: 0.25rem 0.375rem;
    }
}
</style>
{% endblock %}

{% block content %}
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Create New Ticket</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'tickets:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'tickets:ticket_list' %}">Tickets</a></li>
                        <li class="breadcrumb-item active">Create New</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <!-- Create Ticket Form -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-plus-circle"></i> New Ticket Details
                            </h3>
                        </div>

                        <!-- Display form errors -->
                        {% if form.errors %}
                            <div class="alert alert-danger alert-dismissible m-3">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;
                                </button>
                                <h5><i class="icon fas fa-ban"></i> Please correct the following errors:</h5>
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <p class="mb-1">{{ field|capfirst }}: {{ error }}</p>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="card-body">
                                <!-- Title Field -->
                                <div class="form-group">
                                    <label for="id_title">
                                        Title <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           class="form-control {% if form.title.errors %}is-invalid{% endif %}"
                                           id="id_title"
                                           name="title"
                                           placeholder="Enter a clear, descriptive title for your ticket"
                                           value="{{ form.title.value|default:'' }}"
                                           required>
                                    <small class="form-text text-muted">
                                        Provide a brief but descriptive title that summarizes your issue or request.
                                    </small>
                                    {% if form.title.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Description Field -->
                                <div class="form-group">
                                    <label for="id_description">
                                        Description
                                    </label>
                                    <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                                              id="id_description"
                                              name="description"
                                              rows="6"
                                              placeholder="Provide detailed information about your issue or request...">{{ form.description.value|default:'' }}</textarea>
                                    <small class="form-text text-muted">
                                        Include as much detail as possible: what happened, when it happened, steps to
                                        reproduce, etc.
                                    </small>
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.description.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Category Field -->
                                <div class="form-group">
                                    <label for="id_category">
                                        Category
                                    </label>
                                    <select class="form-control {% if form.category.errors %}is-invalid{% endif %}"
                                            id="id_category"
                                            name="category">
                                        <option value="">Select Category (Optional)</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}"
                                                    {% if form.category.value == category.id %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        Choose the category that best describes your request to help with proper
                                        assignment.
                                    </small>
                                    {% if form.category.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.category.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Priority Field -->
                                <div class="form-group">
                                    <label for="id_priority">
                                        Priority <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control {% if form.priority.errors %}is-invalid{% endif %}"
                                            id="id_priority"
                                            name="priority"
                                            required>
                                        <option value="">Select Priority Level</option>
                                        <option value="Low" {% if form.priority.value == 'Low' %}selected{% endif %}>
                                            Low - Minor issue, no urgent timeline
                                        </option>
                                        <option value="Medium"
                                                {% if form.priority.value == 'Medium' %}selected{% endif %}>
                                            Medium - Standard issue, normal timeline
                                        </option>
                                        <option value="High" {% if form.priority.value == 'High' %}selected{% endif %}>
                                            High - Important issue, needs prompt attention
                                        </option>
                                        <option value="Urgent"
                                                {% if form.priority.value == 'Urgent' %}selected{% endif %}>
                                            Urgent - Critical issue, immediate attention required
                                        </option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Choose the appropriate priority level based on the urgency and impact of your
                                        issue.
                                    </small>
                                    {% if form.priority.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.priority.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Assignment Field (Only for Admin/Staff Users) -->
                                {% if user.is_staff or user.is_superuser %}
                                    <div class="form-group">
                                        <label for="id_assigned_to">
                                            <i class="fas fa-user-cog"></i> Assign To Staff Member
                                        </label>
                                        <select class="form-control"
                                                id="id_assigned_to"
                                                name="assigned_to">
                                            <option value="">Select Staff Member (Optional)</option>
                                            {% for assignable_user in admin_users %}
                                                <option value="{{ assignable_user.id }}">
                                                    {{ assignable_user.get_full_name|default:assignable_user.username }}
                                                    {% if assignable_user.userprofile.department %} -
                                                        {{ assignable_user.userprofile.department }}{% endif %}
                                                    {% if assignable_user.is_superuser %} (Super Admin){% else %}
                                                        (Staff){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle text-info"></i>
                                            As an admin, you can assign this ticket to any staff member for immediate
                                            attention.
                                            Leave blank to keep unassigned.
                                        </small>
                                    </div>
                                {% endif %}

                                <!-- CC Admins Field -->
                                {% if user.is_staff or user.is_superuser %}
                                    <div class="form-group">
                                        <label for="cc-admins-input">
                                            <i class="fas fa-user-shield text-success"></i> CC Admins
                                        </label>
                                        <div class="multiselect-container" data-field="cc_admins">
                                            <div class="form-control multiselect-input d-flex flex-wrap align-items-center" style="min-height: 38px; padding: 0.25rem 0.5rem;">
                                                <!-- Selected tags will appear here -->
                                                <input type="text" class="search-input flex-grow-1 border-0" placeholder="Type to search admins..." style="outline: none; min-width: 150px; background: transparent;">
                                            </div>
                                            <div class="dropdown-menu multiselect-dropdown w-100" style="max-height: 200px; overflow-y: auto;">
                                                {% for admin_user in admin_users %}
                                                    <div class="dropdown-item multiselect-option" data-value="{{ admin_user.id }}" data-text="{{ admin_user.get_full_name|default:admin_user.username }}">
                                                        <i class="fas fa-user-circle text-primary me-2"></i>
                                                        {{ admin_user.get_full_name|default:admin_user.username }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <!-- Hidden select for form submission -->
                                            <select name="cc_admins" multiple class="d-none" id="cc_admins_hidden">
                                                {% for admin_user in admin_users %}
                                                    <option value="{{ admin_user.id }}">{{ admin_user.get_full_name|default:admin_user.username }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> Staff members who will receive updates. Type to search, click to select.
                                        </small>
                                        {% if form.cc_admins.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.cc_admins.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- CC Non-Admins Field -->
                                    <div class="form-group">
                                        <label for="cc-users-input">
                                            <i class="fas fa-users text-info"></i> CC Users
                                        </label>
                                        <div class="multiselect-container" data-field="cc_non_admins">
                                            <div class="form-control multiselect-input d-flex flex-wrap align-items-center" style="min-height: 38px; padding: 0.25rem 0.5rem;">
                                                <!-- Selected tags will appear here -->
                                                <input type="text" class="search-input border-0 flex-grow-1" placeholder="Type to search users..." style="outline: none; min-width: 150px; background: transparent;">
                                            </div>
                                            <div class="dropdown-menu multiselect-dropdown w-100" style="max-height: 200px; overflow-y: auto;">
                                                {% for regular_user in regular_users %}
                                                    <div class="dropdown-item multiselect-option" data-value="{{ regular_user.id }}" data-text="{{ regular_user.get_full_name|default:regular_user.username }}">
                                                        <i class="fas fa-user-circle text-info me-2"></i>
                                                        {{ regular_user.get_full_name|default:regular_user.username }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <!-- Hidden select for form submission -->
                                            <select name="cc_non_admins" multiple class="d-none" id="cc_non_admins_hidden">
                                                {% for regular_user in regular_users %}
                                                    <option value="{{ regular_user.id }}">{{ regular_user.get_full_name|default:regular_user.username }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> Regular users who will receive updates. Type to search, click to select.
                                        </small>
                                        {% if form.cc_non_admins.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.cc_non_admins.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                <!-- Attachments Section -->
                                <div class="form-group mb-4">
                                    <label for="id_attachments">
                                        <i class="fas fa-paperclip"></i> <strong>Attachments</strong> <span
                                            class="text-muted">(Optional)</span>
                                    </label>
                                    <div class="bg-alert-warning text-center py-2 px-3 mb-2 mt-6 ">
                                        <i class="fas fa-info-circle text-warning"></i>
                                        <strong>Allowed:</strong> JPG, PNG, WebP (max 3MB each), PDF (max 5MB each).<br>
                                        <span class="text-small">You can upload multiple files to help explain your issue.</span>
                                    </div>
                                    <div class="custom-file mb-2" style="position:relative;">
                                        <input type="file" class="custom-file-input" id="id_attachments"
                                               name="attachments" multiple accept=".jpg,.jpeg,.png,.webp,.pdf"
                                               style="display:none;">
                                        <div id="drop-area" class="border rounded bg-light text-center py-3"
                                             style="cursor:pointer; border-style:dashed; margin-top:8px;">
                                            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i><br>
                                            <span class="text-secondary">Drag & drop files here or click to select</span>
                                        </div>
                                    </div>
                                    <!-- File Preview Area -->
                                    <div id="file-preview" class="mt-4" style="display: none;">
                                        <h6 class="text-muted mb-2"><i class="fas fa-list"></i> Selected Files:</h6>
                                        <div id="file-list" class="border rounded p-2 bg-white">
                                            <!-- Files will be listed here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- User Information Display -->
                                <div class="form-group">
                                    <label><i class="fas fa-user"></i> Ticket Creator Information</label>
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Name:</strong>
                                                    {{ user.get_full_name|default:user.username }}<br>
                                                    <strong>Username:</strong> {{ user.username }}
                                                </div>
                                                <div class="col-md-6">
                                                    {% if user.userprofile %}
                                                        {% if user.userprofile.department %}
                                                            <strong>Department:</strong>
                                                            {{ user.userprofile.department }}<br>
                                                        {% endif %}
                                                        {% if user.userprofile.location %}
                                                            <strong>Location:</strong> {{ user.userprofile.location }}
                                                            <br>
                                                        {% endif %}
                                                        {% if user.userprofile.role %}
                                                            <strong>Role:</strong> {{ user.userprofile.role }}
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        This ticket will be created under your account. Contact information is
                                        automatically included.
                                    </small>
                                </div>
                            </div>

                            <div class="card-footer">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-danger btn-lg w-100 mt-2"
                                                onclick="resetForm()">
                                            <i class="fas fa-undo"></i> Reset Form
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <button type="submit" class="btn btn-success btn-lg w-100 mt-2">
                                            <i class="fas fa-save"></i> Create Ticket
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Help Sidebar -->
                <div class="col-md-4">
                    <!-- Help & Tips -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-lightbulb mr-1"></i> Tips for Better Tickets
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="callout callout-info">
                                <h5>Writing Effective Titles</h5>
                                <p>Use clear, specific titles that describe the issue:</p>
                                <ul class="mb-0">
                                    <li>"Login page returns 500 error on Chrome" <i
                                            class="fas fa-check text-success"></i></li>
                                    <li>"Something is broken" <i class="fas fa-times text-danger"></i></li>
                                </ul>
                            </div>

                            <div class="callout callout-warning">
                                <h5> Include Details</h5>
                                <p>Help us help you faster by including:</p>
                                <ul class="mb-0">
                                    <li>Steps to reproduce the issue</li>
                                    <li>What you expected to happen</li>
                                    <li>What actually happened</li>
                                    <li>Browser/device information if relevant</li>
                                </ul>
                            </div>

                            <div class="callout callout-success">
                                <h5>Priority Guidelines</h5>
                                <ul class="mb-0">
                                    <li><strong>Urgent:</strong> System down, security issues</li>
                                    <li><strong>High:</strong> Major functionality broken</li>
                                    <li><strong>Medium:</strong> Minor bugs, feature requests</li>
                                    <li><strong>Low:</strong> Nice-to-have improvements</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-bolt"></i> Quick Actions
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="btn-group-vertical btn-block">
                                <a href="{% url 'tickets:ticket_list' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-list"></i> View My Tickets
                                </a>
                                <a href="{% url 'tickets:home' %}" class="btn btn-outline-info">
                                    <i class="fas fa-home"></i> Back to Dashboard
                                </a>
                                {% if user.is_staff %}
                                    <a href="/admin/tickets/ticket/" target="_blank" class="btn btn-outline-warning">
                                        <i class="fas fa-cogs"></i> Manage All Tickets
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card card-light">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i> Your Recent Activity
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="text-center p-3">
                                <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                                <p class="text-muted">Your recent tickets will appear here.</p>
                                <small class="text-muted">Create your first ticket to get started!</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
    <script>
        // Pure JavaScript Bootstrap Multiselect Implementation
        class BootstrapMultiselect {
            constructor(container) {
                this.container = container;
                this.fieldName = container.dataset.field;
                this.input = container.querySelector('.multiselect-input');
                this.searchInput = container.querySelector('.search-input');
                this.dropdown = container.querySelector('.multiselect-dropdown');
                this.hiddenSelect = container.querySelector('select');
                this.options = Array.from(container.querySelectorAll('.multiselect-option'));
                this.selectedValues = new Set();
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.setupDropdown();
            }
            
            bindEvents() {
                // Search input events
                this.searchInput.addEventListener('focus', () => this.showDropdown());
                this.searchInput.addEventListener('input', (e) => this.filterOptions(e.target.value));
                this.searchInput.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.hideDropdown();
                    }
                });
                
                // Option clicks
                this.options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.toggleOption(option);
                    });
                });
                
                // Input container click to focus search
                this.input.addEventListener('click', (e) => {
                    if (e.target === this.input) {
                        this.searchInput.focus();
                    }
                });
            }
            
            setupDropdown() {
                this.dropdown.style.display = 'none';
                this.dropdown.style.position = 'absolute';
                this.dropdown.style.top = '100%';
                this.dropdown.style.left = '0';
                this.dropdown.style.right = '0';
                this.dropdown.style.zIndex = '1000';
                this.dropdown.style.border = '1px solid #ced4da';
                this.dropdown.style.borderTop = 'none';
                this.dropdown.style.borderRadius = '0 0 0.25rem 0.25rem';
                this.dropdown.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                
                // Make container relative for dropdown positioning
                this.container.style.position = 'relative';
            }
            
            showDropdown() {
                this.dropdown.style.display = 'block';
                this.input.style.borderBottomLeftRadius = '0';
                this.input.style.borderBottomRightRadius = '0';
                this.filterOptions(this.searchInput.value);
            }
            
            hideDropdown() {
                this.dropdown.style.display = 'none';
                this.input.style.borderBottomLeftRadius = '';
                this.input.style.borderBottomRightRadius = '';
                this.searchInput.value = '';
                this.filterOptions('');
            }
            
            filterOptions(query) {
                const search = query.toLowerCase();
                this.options.forEach(option => {
                    const text = option.dataset.text.toLowerCase();
                    const isVisible = text.includes(search);
                    option.style.display = isVisible ? 'block' : 'none';
                });
            }
            
            toggleOption(option) {
                const value = option.dataset.value;
                const text = option.dataset.text;
                
                if (this.selectedValues.has(value)) {
                    this.removeSelection(value);
                } else {
                    this.addSelection(value, text);
                }
                
                this.updateHiddenSelect();
                this.searchInput.focus();
            }
            
            addSelection(value, text) {
                this.selectedValues.add(value);
                
                // Create tag
                const tag = document.createElement('span');
                tag.className = 'badge badge-primary me-1 m-1 d-inline-flex align-items-center';
                tag.dataset.value = value;
                tag.innerHTML = `
                    ${text}
                    <button type="button" class="btn-close btn-danger m-1 rounded" style="font-size: 0.65em;" aria-label="Remove">&times;</button>
                `;
                
                // Add remove functionality
                tag.querySelector('.btn-close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.removeSelection(value);
                    this.updateHiddenSelect();
                });
                
                // Insert before search input
                this.input.insertBefore(tag, this.searchInput);
                
                // Update option appearance
                const option = this.options.find(opt => opt.dataset.value === value);
                if (option) {
                    option.classList.add('active');
                    option.style.backgroundColor = '#007bff';
                    option.style.color = 'white';
                }
            }
            
            removeSelection(value) {
                this.selectedValues.delete(value);
                
                // Remove tag
                const tag = this.input.querySelector(`[data-value="${value}"]`);
                if (tag) {
                    tag.remove();
                }
                
                // Update option appearance
                const option = this.options.find(opt => opt.dataset.value === value);
                if (option) {
                    option.classList.remove('active');
                    option.style.backgroundColor = '';
                    option.style.color = '';
                }
            }
            
            updateHiddenSelect() {
                // Clear existing selections
                Array.from(this.hiddenSelect.options).forEach(option => {
                    option.selected = false;
                });
                
                // Set new selections
                this.selectedValues.forEach(value => {
                    const option = this.hiddenSelect.querySelector(`option[value="${value}"]`);
                    if (option) {
                        option.selected = true;
                    }
                });
            }
            
            handleKeydown(e) {
                if (e.key === 'Escape') {
                    this.hideDropdown();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    // Find first visible option and select it
                    const visibleOption = this.options.find(opt => opt.style.display !== 'none');
                    if (visibleOption) {
                        this.toggleOption(visibleOption);
                    }
                }
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize multiselects
            const containers = document.querySelectorAll('.multiselect-container');
            containers.forEach(container => {
                new BootstrapMultiselect(container);
            });

            // Character counter for description
            const descriptionField = document.getElementById('id_description');
            if (descriptionField) {
                descriptionField.addEventListener('input', function () {
                    const maxLength = 2000;
                    const currentLength = this.value.length;
                    const remaining = maxLength - currentLength;
                    let counter = document.getElementById('char-counter');
                    
                    if (!counter) {
                        counter = document.createElement('small');
                        counter.id = 'char-counter';
                        counter.className = 'form-text text-muted';
                        this.parentNode.appendChild(counter);
                    }
                    
                    counter.textContent = `${currentLength} characters`;
                    if (remaining < 100) {
                        counter.className = 'form-text text-warning';
                    } else {
                        counter.className = 'form-text text-muted';
                    }
                });
            }

            // Form validation
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    let isValid = true;
                    const title = document.getElementById('id_title').value.trim();
                    const priority = document.getElementById('id_priority').value;
                    
                    const titleField = document.getElementById('id_title');
                    const priorityField = document.getElementById('id_priority');
                    
                    if (!title) {
                        isValid = false;
                        titleField.classList.add('is-invalid');
                    } else {
                        titleField.classList.remove('is-invalid');
                    }
                    
                    if (!priority) {
                        isValid = false;
                        priorityField.classList.add('is-invalid');
                    } else {
                        priorityField.classList.remove('is-invalid');
                    }
                    
                    if (isValid) {
                        const submitBtn = this.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Ticket...';
                            submitBtn.disabled = true;
                        }
                    }
                    
                    return isValid;
                });
            }

            // Priority selection helper
            const priorityField = document.getElementById('id_priority');
            if (priorityField) {
                priorityField.addEventListener('change', function () {
                    const priority = this.value;
                    const helpText = {
                        'Low': 'Low priority tickets are typically addressed within 3-5 business days.',
                        'Medium': 'Medium priority tickets are typically addressed within 1-2 business days.',
                        'High': 'High priority tickets are typically addressed within 4-8 hours.',
                        'Urgent': 'Urgent tickets receive immediate attention and are prioritized over all other work.'
                    };
                    
                    if (priority && helpText[priority]) {
                        let help = document.getElementById('priority-help');
                        if (!help) {
                            help = document.createElement('small');
                            help.id = 'priority-help';
                            help.className = 'form-text';
                            this.parentNode.appendChild(help);
                        }
                        
                        help.textContent = helpText[priority];
                        const colors = {
                            'Low': 'text-success',
                            'Medium': 'text-info',
                            'High': 'text-warning',
                            'Urgent': 'text-danger'
                        };
                        help.className = `form-text ${colors[priority]}`;
                    }
                });
            }

            // File upload handling
            const fileInput = document.getElementById('id_attachments');
            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    handleFiles(this.files);
                });
            }

            // Drag & drop support
            const dropArea = document.getElementById('drop-area');
            if (dropArea && fileInput) {
                dropArea.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.add('bg-info', 'text-white');
                });
                
                dropArea.addEventListener('dragleave', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('bg-info', 'text-white');
                });
                
                dropArea.addEventListener('drop', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.classList.remove('bg-info', 'text-white');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleFiles(files);
                    }
                });
                
                dropArea.addEventListener('click', function () {
                    fileInput.click();
                });
            }

            // Helper to handle files
            function handleFiles(files) {
                const fileList = document.getElementById('file-list');
                const filePreview = document.getElementById('file-preview');
                
                if (files.length > 0) {
                    fileList.innerHTML = '';
                    filePreview.style.display = 'block';
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                        const isValid = validateFile(file);
                        
                        const fileItem = document.createElement('div');
                        fileItem.className = `file-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded ${isValid.valid ? 'border-success bg-light' : 'border-danger bg-danger-light'}`;
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <i class="fas ${getFileIcon(file.type)} mr-2"></i>
                                <strong>${file.name}</strong>
                                <span class="text-muted ml-2">(${fileSize} MB)</span>
                                ${!isValid.valid ? `<br><small class="text-danger">${isValid.error}</small>` : ''}
                            </div>
                            <div class="file-actions">
                                ${isValid.valid ?
                                '<i class="fas fa-check-circle text-success"></i>' :
                                '<i class="fas fa-times-circle text-danger"></i>'
                            }
                            </div>
                        `;
                        fileList.appendChild(fileItem);
                    }
                } else {
                    filePreview.style.display = 'none';
                }
            }
        });

        // File validation function
        function validateFile(file) {
            const allowedTypes = {
                'image/jpeg': {maxSize: 3, name: 'JPEG Image'},
                'image/jpg': {maxSize: 3, name: 'JPG Image'},
                'image/png': {maxSize: 3, name: 'PNG Image'},
                'image/webp': {maxSize: 3, name: 'WebP Image'},
                'application/pdf': {maxSize: 5, name: 'PDF Document'}
            };

            const fileSizeMB = file.size / (1024 * 1024);

            if (!allowedTypes[file.type]) {
                return {
                    valid: false,
                    error: 'File type not allowed. Only JPG, PNG, WebP images and PDF documents are supported.'
                };
            }

            if (fileSizeMB > allowedTypes[file.type].maxSize) {
                return {
                    valid: false,
                    error: `File too large. Maximum size for ${allowedTypes[file.type].name} is ${allowedTypes[file.type].maxSize}MB.`
                };
            }

            return {valid: true};
        }

        // Get file icon based on type
        function getFileIcon(type) {
            if (type.startsWith('image/')) {
                return 'fa-image';
            } else if (type === 'application/pdf') {
                return 'fa-file-pdf';
            }
            return 'fa-file';
        }

        // Reset form function
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
                document.querySelector('form').reset();
                const invalidFields = document.querySelectorAll('.is-invalid');
                invalidFields.forEach(field => field.classList.remove('is-invalid'));
                
                const helpers = document.querySelectorAll('#char-counter, #priority-help');
                helpers.forEach(helper => helper.remove());
                
                const filePreview = document.getElementById('file-preview');
                const fileList = document.getElementById('file-list');
                if (filePreview) filePreview.style.display = 'none';
                if (fileList) fileList.innerHTML = '';
            }
        }
    </script>
{% endblock %}
